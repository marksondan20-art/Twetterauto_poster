name: Tweet site posts (12:00 & 19:00 Baghdad)

on:
  schedule:
    # GitHub = UTC ; Baghdad = UTC+03:00
    - cron: '0 9 * * *'   # 12:00 Baghdad
    - cron: '0 16 * * *'  # 19:00 Baghdad
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'لا تنشر، فقط اختبر الاتصال (0/1)'
        required: false
        default: '0'

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      BLOG_RSS:              ${{ secrets.BLOG_RSS }}         # مثال: https://loadingapk391.blogspot.com/feeds/posts/default?alt=rss
      TW_API_KEY:            ${{ secrets.TW_API_KEY }}
      TW_API_SECRET:         ${{ secrets.TW_API_SECRET }}
      TW_ACCESS_TOKEN:       ${{ secrets.TW_ACCESS_TOKEN }}
      TW_ACCESS_SECRET:      ${{ secrets.TW_ACCESS_SECRET }}
      DRY_RUN:               ${{ inputs.dry_run || '0' }}
      TZ:                    Asia/Baghdad

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Diagnose Twitter auth
        run: |
          python - <<'PY'
          import os, tweepy, sys
          try:
              auth = tweepy.OAuth1UserHandler(
                  os.environ["TW_API_KEY"], os.environ["TW_API_SECRET"],
                  os.environ["TW_ACCESS_TOKEN"], os.environ["TW_ACCESS_SECRET"]
              )
              api = tweepy.API(auth)
              me = api.verify_credentials()
              print("AUTH_OK for:", me.screen_name)
          except Exception as e:
              print("AUTH_FAIL:", repr(e))
              sys.exit(1)
          PY

      - name: Run poster
        run: |
          python - <<'PY'
          import os, re, time, feedparser, tweepy
          from urllib.parse import urlparse, parse_qs

          DRY = os.getenv("DRY_RUN","0") == "1"
          RSS = os.getenv("BLOG_RSS","").strip()

          if not RSS:
              raise SystemExit("BLOG_RSS secret مفقود (مثال صالح: https://<blog>.blogspot.com/feeds/posts/default?alt=rss)")

          # --- اجلب أحدث 3 مقالات من RSS
          feed = feedparser.parse(RSS)
          items = feed.entries[:3] if feed.entries else []
          if not items:
              raise SystemExit("لا توجد عناصر RSS لعرضها.")

          # --- جهّز تويتر (OAuth 1.0a user context)
          auth = tweepy.OAuth1UserHandler(
              os.environ["TW_API_KEY"], os.environ["TW_API_SECRET"],
              os.environ["TW_ACCESS_TOKEN"], os.environ["TW_ACCESS_SECRET"]
          )
          api = tweepy.API(auth)

          posted = 0
          for e in items:
              title = (getattr(e, "title", "") or "").strip()
              link  = (getattr(e, "link", "") or "").strip()
              if not title or not link:
                  continue

              # صيغة سؤال جذّاب + هاشتاغ #لودينغ + رابط القناة
              yt = "https://www.youtube.com/@-Muhamedloading"
              text = f"سؤال: {title}؟\nإذا حابب تعرف أكتر، لودينغ موجودة لخدمتكم — تابع القراءة من الموقع الرسمي:\n{link}\n\n#لودينغ\nقناتنا على يوتيوب: {yt}"

              if DRY:
                  print("DRY_RUN →", text[:120].replace("\n"," ") + "...")
              else:
                  try:
                      api.update_status(status=text[:280])  # قصّ إلى حد تويتر
                      print("TWEETED:", title)
                      posted += 1
                      time.sleep(2)
                  except Exception as e:
                      print("TWEET_ERROR:", title, repr(e))

          if not DRY and posted == 0:
              raise SystemExit("لم يتم نشر أي تغريدة (تحقق من الصلاحيات: Read and write).")
          PY
