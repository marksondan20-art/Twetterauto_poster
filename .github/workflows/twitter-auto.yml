name: X Poster (12:00 & 19:00 Baghdad)

on:
  schedule:
    # GitHub يعمل بـ UTC — بغداد = UTC+03:00
    - cron: '0 9 * * *'   # 12:00 Baghdad
    - cron: '0 16 * * *'  # 19:00 Baghdad
  workflow_dispatch:
    inputs:
      mode:
        description: 'publish | run_once'
        type: choice
        options: [publish, run_once]
        default: publish
      count:
        description: 'كم تغريدة في هذا التشغيل (1-3)'
        default: '1'
        required: false

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      TZ: Asia/Baghdad

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install tweepy>=4.14.0 requests>=2.32.3

      - name: Decide task
        id: decide
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "task=publish" >> "$GITHUB_OUTPUT"
            echo "count=1"     >> "$GITHUB_OUTPUT"
          else
            echo "task=${{ inputs.mode }}"  >> "$GITHUB_OUTPUT"
            echo "count=${{ inputs.count }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish now
        env:
          MODE:  ${{ steps.decide.outputs.task }}
          COUNT: ${{ steps.decide.outputs.count }}
          TW_API_KEY:        ${{ secrets.TW_API_KEY }}
          TW_API_SECRET:     ${{ secrets.TW_API_SECRET }}
          TW_ACCESS_TOKEN:   ${{ secrets.TW_ACCESS_TOKEN }}
          TW_ACCESS_SECRET:  ${{ secrets.TW_ACCESS_SECRET }}
        run: |
          echo "MODE=${MODE}  COUNT=${COUNT:-1}"
          python - <<'PY'
          import os, sys, textwrap, time
          import tweepy

          def make_client():
              try:
                  client = tweepy.Client(
                      consumer_key=os.environ["TW_API_KEY"],
                      consumer_secret=os.environ["TW_API_SECRET"],
                      access_token=os.environ["TW_ACCESS_TOKEN"],
                      access_token_secret=os.environ["TW_ACCESS_SECRET"],
                      wait_on_rate_limit=True,
                  )
                  me = client.get_me()
                  print("AUTH_OK for:", "@"+me.data.username)
                  return client
              except Exception as e:
                  print("AUTH_FAIL:", repr(e))
                  print(textwrap.dedent("""
                  تأكد من:
                  1) App permissions = Read and write في بوابة X
                  2) أعد توليد Access Token & Secret بعد تغيير الصلاحيات
                  3) القيم الأربع كلها لنفس التطبيق ونفس الحساب
                  """).strip())
                  sys.exit(1)

          def post_tweet_v2(client, text):
              try:
                  r = client.create_tweet(text=text)
                  tid = r.data.get("id")
                  print("TWEET_OK:", f"https://x.com/i/web/status/{tid}")
                  return True
              except tweepy.Forbidden as e:
                  print("403 Forbidden:", e)
                  print("الحل: استخدم v2 (create_tweet) مع Read/Write، وإن استمر راجع الخطة/الصلاحيات.")
                  return False
              except Exception as e:
                  print("TWEET_ERR:", repr(e))
                  return False

          MODE  = os.getenv("MODE","publish")
          COUNT = int(os.getenv("COUNT") or 1)

          client = make_client()

          # ضع منطق جلب عنوان/رابط مقالاتك هنا لاحقاً. حالياً نصوص تجريبية:
          base_texts = [
              "مقال جديد على موقعنا: هل الذكاء الاصطناعي يُعيد تشكيل حياتنا اليومية؟ #لودينغ",
              "تحليل سريع لخبر تقني ترند — التفاصيل على موقعنا. #لودينغ",
              "أبرز ما حدث اليوم في عالم التكنولوجيا… القراءة الكاملة بالمصدر. #لودينغ",
          ]

          ok_any = False
          for i in range(COUNT):
              text = base_texts[i % len(base_texts)]
              # مثال دمج العنوان والرابط عند ربطه مع موقعك:
              # text = f"{title}\n{url}\n#لودينغ"
              ok = post_tweet_v2(client, text)
              ok_any = ok_any or ok
              time.sleep(2)

          if not ok_any:
              sys.exit(1)
          PY
