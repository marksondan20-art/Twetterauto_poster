- name: Diagnose Twitter auth
  run: |
    python - <<'PY'
    import os, sys, textwrap, tweepy

    req = ["TW_API_KEY","TW_API_SECRET","TW_ACCESS_TOKEN","TW_ACCESS_SECRET"]
    missing = [k for k in req if not os.getenv(k)]
    if missing:
        print("MISSING_SECRETS:", missing); sys.exit(1)

    print("HAS_KEYS:",
          {k: ("set" if os.getenv(k) else "missing") for k in req})

    try:
        auth = tweepy.OAuth1UserHandler(
            os.environ["TW_API_KEY"], os.environ["TW_API_SECRET"],
            os.environ["TW_ACCESS_TOKEN"], os.environ["TW_ACCESS_SECRET"]
        )
        api = tweepy.API(auth, wait_on_rate_limit=True)
        me = api.verify_credentials()
        if not me:
            raise RuntimeError("verify_credentials returned None")
        print("AUTH_OK for @%s (id=%s)" % (me.screen_name, me.id))
    except Exception as e:
        print("AUTH_FAIL:", repr(e))
        print(textwrap.dedent("""
        تحقق من الآتي:
        1) User authentication settings = OAuth 1.0a مفعلة
        2) App permissions = Read and write (وليس Read فقط)
        3) Regenerate Access Token & Secret بعد تغيير الصلاحيات
        4) استخدم OAuth 1.0a Access Token/Secret (ليست OAuth 2.0)
        5) إن بقي 401 قد تحتاج Basic plan للسماح بالكتابة
        """).strip())
        sys.exit(1)
    PY
