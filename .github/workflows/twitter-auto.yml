name: Trend → X (12:00 & 19:00 Baghdad)

on:
  schedule:
    # GitHub = UTC ; Baghdad = UTC+03:00
    - cron: '0 9 * * *'   # 12:00 بغداد
    - cron: '0 16 * * *'  # 19:00 بغداد
  workflow_dispatch:
    inputs:
      mode:
        description: 'publish (النشر) | run_once (تشغيل يدوي)'
        type: choice
        options: [publish, run_once]
        default: publish
      count:
        description: 'كم تغريدة الآن (1-3)'
        default: '1'
        required: false

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      BLOG_URL:            ${{ secrets.BLOG_URL }}
      CLIENT_ID:           ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET:       ${{ secrets.CLIENT_SECRET }}
      REFRESH_TOKEN:       ${{ secrets.REFRESH_TOKEN }}
      TW_API_KEY:          ${{ secrets.TW_API_KEY }}
      TW_API_SECRET:       ${{ secrets.TW_API_SECRET }}
      TW_ACCESS_TOKEN:     ${{ secrets.TW_ACCESS_TOKEN }}
      TW_ACCESS_SECRET:    ${{ secrets.TW_ACCESS_SECRET }}
      YOUTUBE_URL:         ${{ secrets.YOUTUBE_URL }}
      TZ:                  Asia/Baghdad

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Decide
        id: decide
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "mode=publish" >> "$GITHUB_OUTPUT"
            echo "count=1" >> "$GITHUB_OUTPUT"
          else
            echo "mode=${{ inputs.mode }}"  >> "$GITHUB_OUTPUT"
            echo "count=${{ inputs.count }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish now
        env:
          MODE:  ${{ steps.decide.outputs.mode }}
          COUNT: ${{ steps.decide.outputs.count }}
        run: |
          echo "MODE=${MODE}  COUNT=${COUNT:-1}"
          python - <<'PY'
          import os, sys
          import main
          # ننشر count تغريدات من أحدث المقالات
          try:
              n = int(os.getenv("COUNT") or 1)
          except:
              n = 1
          main.tweet_new_posts(max(1, min(3, n)))
          PY
