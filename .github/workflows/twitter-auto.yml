name: Trend → X (12:00 & 19:00 Baghdad)

on:
  schedule:
    # GitHub = UTC ; Baghdad = UTC+03:00
    - cron: '0 9 * * *'   # 12:00 بغداد
    - cron: '0 16 * * *'  # 19:00 بغداد
  workflow_dispatch:
    inputs:
      mode:
        description: 'publish (النشر) | run_once (تشغيل يدوي)'
        type: choice
        options: [publish, run_once]
        default: publish
      count:
        description: 'كم تغريدة الآن (1-3)'
        default: '1'
        required: false

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      BLOG_URL:            ${{ secrets.BLOG_URL }}
      CLIENT_ID:           ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET:       ${{ secrets.CLIENT_SECRET }}
      REFRESH_TOKEN:       ${{ secrets.REFRESH_TOKEN }}
      TW_API_KEY:          ${{ secrets.TW_API_KEY }}
      TW_API_SECRET:       ${{ secrets.TW_API_SECRET }}
      TW_ACCESS_TOKEN:     ${{ secrets.TW_ACCESS_TOKEN }}
      TW_ACCESS_SECRET:    ${{ secrets.TW_ACCESS_SECRET }}
      YOUTUBE_URL:         ${{ secrets.YOUTUBE_URL }}
      TZ:                  Asia/Baghdad

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Diagnose Blogger env
        run: |
          python - <<'PY'
          import os, sys
          need = ["BLOG_URL","CLIENT_ID","CLIENT_SECRET","REFRESH_TOKEN"]
          missing = [k for k in need if not os.getenv(k)]
          if missing:
              print("MISSING:", ", ".join(missing))
              sys.exit(1)
          print("ENV_OK: Blogger creds present.")
          try:
              from google.oauth2.credentials import Credentials
              from googleapiclient.discovery import build
              creds = Credentials(
                  None,
                  refresh_token=os.environ["REFRESH_TOKEN"],
                  client_id=os.environ["CLIENT_ID"],
                  client_secret=os.environ["CLIENT_SECRET"],
                  token_uri="https://oauth2.googleapis.com/token",
                  scopes=["https://www.googleapis.com/auth/blogger"],
              )
              svc = build("blogger","v3",credentials=creds, cache_discovery=False)
              blog = svc.blogs().getByUrl(url=os.environ["BLOG_URL"]).execute()
              print("BLOG_OK:", blog.get("id"), blog.get("name"))
          except Exception as e:
              print("BLOG_FAIL:", repr(e))
              sys.exit(1)
          PY

      - name: Decide
        id: decide
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "mode=publish" >> "$GITHUB_OUTPUT"
            echo "count=1" >> "$GITHUB_OUTPUT"
          else
            echo "mode=${{ inputs.mode }}"  >> "$GITHUB_OUTPUT"
            echo "count=${{ inputs.count }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish now
        env:
          MODE:  ${{ steps.decide.outputs.mode }}
          COUNT: ${{ steps.decide.outputs.count }}
        run: |
          echo "MODE=${MODE}  COUNT=${COUNT:-1}"
          python - <<'PY'
          import os, sys
          import main
          # ننشر count تغريدات من أحدث المقالات
          try:
              n = int(os.getenv("COUNT") or 1)
          except:
              n = 1
          main.tweet_new_posts(max(1, min(3, n)))
          PY
