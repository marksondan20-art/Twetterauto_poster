name: Twitter poster (12:00 & 19:00 Baghdad)

on:
  schedule:
    # GitHub = UTC ; Baghdad = UTC+03:00
    - cron: '0 9 * * *'   # 12:00 Baghdad
    - cron: '0 16 * * *'  # 19:00 Baghdad
  workflow_dispatch:
    inputs:
      mode:
        description: 'publish or run_once'
        type: choice
        options: [publish, run_once]
        default: publish
      count:
        description: 'times for run_once (1-3)'
        required: false
        default: '1'

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      # Twitter (OAuth 1.0a – لازم تكون مفاتيح user context)
      TW_API_KEY:        ${{ secrets.TW_API_KEY }}
      TW_API_SECRET:     ${{ secrets.TW_API_SECRET }}
      TW_ACCESS_TOKEN:   ${{ secrets.TW_ACCESS_TOKEN }}
      TW_ACCESS_SECRET:  ${{ secrets.TW_ACCESS_SECRET }}
      # مصدر المقالات (رابط مدونتك)
      BLOG_URL:          ${{ secrets.BLOG_URL }}
      TZ: Asia/Baghdad

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install tweepy==4.14.0 requests==2.32.3 feedparser==6.0.11

      # اختياري: تشخيص توثيق X (يفيدك قبل أول نشر)
      - name: Diagnose Twitter auth
        run: |
          python - <<'PY'
          import os, sys, tweepy
          need = ["TW_API_KEY","TW_API_SECRET","TW_ACCESS_TOKEN","TW_ACCESS_SECRET"]
          miss = [k for k in need if not os.getenv(k)]
          if miss:
              print("MISSING SECRETS:", miss); sys.exit(1)
          auth = tweepy.OAuth1UserHandler(
              os.environ["TW_API_KEY"], os.environ["TW_API_SECRET"],
              os.environ["TW_ACCESS_TOKEN"], os.environ["TW_ACCESS_SECRET"]
          )
          api = tweepy.API(auth, wait_on_rate_limit=True)
          me = api.verify_credentials()
          if not me: 
              raise SystemExit("verify_credentials returned None")
          print("AUTH_OK:", "@"+me.screen_name)
          PY

      - name: Publish now
        env:
          MODE:  ${{ github.event_name == 'schedule' && 'publish' || inputs.mode }}
          COUNT: ${{ github.event_name == 'schedule' && '1'      || inputs.count }}
        run: |
          echo "MODE=${MODE}  COUNT=${COUNT:-1}"
          python - <<'PY'
          import os, re, textwrap, tweepy, requests, feedparser

          # --- helpers ---
          def latest_posts(blog_url, n=1):
              # Blogger RSS (يعمل لمدونات blogspot ولأي BLOG_URL فيه خلاصة)
              rss = blog_url.rstrip("/") + "/feeds/posts/default?alt=rss"
              f = feedparser.parse(rss)
              out=[]
              for e in (f.entries or [])[:n]:
                  title = e.title
                  link  = getattr(e, "link", blog_url)
                  out.append((title, link))
              return out

          def make_tweet(title, url):
              base = f"{title.strip()} — {url.strip()}  #لودينغ"
              # التقييد 280 حرف
              return base if len(base) <= 280 else (base[:276] + "…")

          # --- twitter api ---
          auth = tweepy.OAuth1UserHandler(
              os.environ["TW_API_KEY"], os.environ["TW_API_SECRET"],
              os.environ["TW_ACCESS_TOKEN"], os.environ["TW_ACCESS_SECRET"]
          )
          api = tweepy.API(auth, wait_on_rate_limit=True)

          blog = os.environ.get("BLOG_URL","").strip()
          if not blog:
              raise SystemExit("BLOG_URL secret is empty")

          mode  = os.environ.get("MODE","publish")
          count = int(os.environ.get("COUNT") or 1)
          count = max(1, min(3, count))

          if mode == "publish":
              posts = latest_posts(blog, n=1)
              if not posts:
                  raise SystemExit("No posts found in feed")
              title, link = posts[0]
              text = make_tweet(title, link)
              api.update_status(status=text)
              print("TWEETED:", text)

          else:  # run_once (لل manual test – يكرر n مرات من أحدث المقالات)
              posts = latest_posts(blog, n=count)
              if not posts:
                  raise SystemExit("No posts found in feed")
              for title, link in posts:
                  text = make_tweet(title, link)
                  api.update_status(status=text)
                  print("TWEETED:", text)
          PY
