name: Tweet Latest Blog Posts (12:00 & 19:00 Baghdad)

on:
  schedule:
    # GitHub = UTC ; Baghdad = UTC+03:00
    - cron: '0 9 * * *'   # 12:00 Baghdad
    - cron: '0 16 * * *'  # 19:00 Baghdad
  workflow_dispatch:

permissions:
  contents: read

jobs:
  tweet:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      SITE_URL:              ${{ secrets.SITE_URL }}
      TW_CONSUMER_KEY:       ${{ secrets.TW_CONSUMER_KEY }}
      TW_CONSUMER_SECRET:    ${{ secrets.TW_CONSUMER_SECRET }}
      TW_ACCESS_TOKEN:       ${{ secrets.TW_ACCESS_TOKEN }}
      TW_ACCESS_SECRET:      ${{ secrets.TW_ACCESS_SECRET }}
      YT_URL:                "https://www.youtube.com/@-Muhamedloading"
      TZ:                    Asia/Baghdad

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tweepy feedparser pytz

      - name: Run tweet script
        run: |
          python - <<'PY'
          import os, random
          import tweepy, feedparser
          from datetime import datetime, timedelta, timezone

          BAGHDAD = timezone(timedelta(hours=3))

          def twitter_api():
              auth = tweepy.OAuth1UserHandler(
                  os.environ["TW_CONSUMER_KEY"],
                  os.environ["TW_CONSUMER_SECRET"],
                  os.environ["TW_ACCESS_TOKEN"],
                  os.environ["TW_ACCESS_SECRET"]
              )
              return tweepy.API(auth)

          api = twitter_api()

          site = os.getenv("SITE_URL", "https://loadingapk391.blogspot.com")
          feed = feedparser.parse(f"{site}/feeds/posts/default?alt=rss")

          if not feed.entries:
              print("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„Ø§ØµØ© RSS.")
              raise SystemExit

          latest = feed.entries[0]
          title, link = latest.title, latest.link
          yt_link = os.getenv("YT_URL")

          starters = [
              "Ù‡Ù„ ØªØ³Ø§Ø¡Ù„Øª ÙŠÙˆÙ…Ù‹Ø§ Ø¹Ù†",
              "Ù…Ø§Ø°Ø§ ØªØ¹Ø±Ù Ø¹Ù†",
              "Ù‡Ù„ ÙÙƒØ±Øª ÙŠÙˆÙ…Ù‹Ø§ ÙƒÙŠÙ ÙŠØ­Ø¯Ø«",
              "Ù‡Ù„ ØªØ¹Ø±Ù Ù…Ø§ Ø§Ù„Ø³Ø± ÙˆØ±Ø§Ø¡",
              "Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¹Ù„ Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø«Ù„"
          ]
          starter = random.choice(starters)

          hashtags = "#Ù„ÙˆØ¯ÙŠÙ†Øº #Loading"
          promo = f"ðŸŽ¬ Ù‚Ù†Ø§Ø© Ù„ÙˆØ¯ÙŠÙ†Øº Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ÙŠØ©:\n{yt_link}"

          text = f"{starter} {title}ØŸ\n\nØ¥Ø°Ø§ Ø­Ø§Ø¨Ø¨ ØªØ¹Ø±Ù Ø£ÙƒØªØ±ØŒ Ù„ÙˆØ¯ÙŠÙ†Øº Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ø®Ø¯Ù…ØªÙƒÙ… â€” ØªØ§Ø¨Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ðŸ‘‡\n{link}\n\n{hashtags}\n\n{promo}"

          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„ØªÙˆÙŠØªØ±
          if len(text) > 280:
              text = text[:277] + "..."

          api.update_status(status=text)
          print(f"âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„ØªØºØ±ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­: {title}")
          PY
